<%- contentFor('body') %>

<!-- Thank You Banner Section -->
<section class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-12">
  <div class="container mx-auto px-4 text-center">
    <div class="mb-6">
      <svg class="w-20 h-20 text-green-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
    </div>
    <h1 class="text-3xl md:text-4xl font-bold mb-4">Đăng Ký Thành Công!</h1>
    <p class="text-xl max-w-2xl mx-auto">Cảm ơn <%= typeof participantName !== 'undefined' ? participantName : "Quý vị" %> đã đăng ký.</p>
    <p class="text-lg mt-2">Chúng tôi rất vui mừng khi quý vị tham gia <%= conference ? conference.name : "Hội Nghị" %>.</p>
  </div>
</section>

<!-- Confirmation Details Section -->
<section class="py-12 bg-gray-50">
  <div class="container mx-auto px-4">
    <div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6 md:p-8">
      <div class="border-b pb-6 mb-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Chi Tiết Sự Kiện</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Tên hội nghị:</h3>
            <p class="text-gray-600"><%= conference ? conference.name : "Hội Nghị" %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Ngày bắt đầu:</h3>
            <p class="text-gray-600"><%= conference && conference.startDate ? new Date(conference.startDate).toLocaleDateString('vi-VN', {year: 'numeric', month: 'long', day: 'numeric'}) : '---' %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Thời gian:</h3>
            <p class="text-gray-600"><%= conference && conference.time ? conference.time : '---' %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Ngày kết thúc:</h3>
            <p class="text-gray-600"><%= formattedDates || '---' %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Địa điểm:</h3>
            <p class="text-gray-600"><%= locationName || '---' %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Địa chỉ:</h3>
            <p class="text-gray-600"><%= locationAddress || '---' %></p>
          </div>
          
          <% if (conference && conference.mainSpeaker) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Diễn giả chính:</h3>
            <p class="text-gray-600"><%= conference.mainSpeaker %></p>
          </div>
          <% } %>
          
          <% if (conference && conference.contactName) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Liên hệ:</h3>
            <p class="text-gray-600"><%= conference.contactName %></p>
          </div>
          <% } %>
          
          <% if (conference && conference.contactPhone) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">SĐT liên hệ:</h3>
            <p class="text-gray-600"><%= conference.contactPhone %></p>
          </div>
          <% } %>
          
          <% if (conference && conference.contactEmail) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Email liên hệ:</h3>
            <p class="text-gray-600"><%= conference.contactEmail %></p>
          </div>
          <% } %>
        </div>
        
        <% if (conference && conference.description) { %>
        <div class="mb-6">
          <h3 class="font-semibold text-gray-700 mb-1">Mô tả hội nghị:</h3>
          <p class="text-gray-600"><%- conference.description %></p>
        </div>
        <% } %>
        
        <h2 class="text-2xl font-bold text-gray-800 my-6 text-center">Thông Tin Đăng Ký</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <% if (typeof participantId !== 'undefined' && participantId) { %>
            <div class="md:col-span-2">
              <h3 class="font-semibold text-gray-700 mb-1">Mã đăng ký:</h3>
              <p class="text-xl font-bold text-blue-600"><%= participantId %></p>
              <p class="text-xs text-gray-500">Mã đăng ký theo thứ tự trong hội nghị này</p>
            </div>
          <% } %>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Họ và tên:</h3>
            <p class="text-gray-600"><%= (participant && participant.name) ? participant.name : (typeof participantName !== 'undefined' ? participantName : '---') %></p>
          </div>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Email:</h3>
            <p class="text-gray-600"><%= (participant && participant.email) ? participant.email : (typeof participantEmail !== 'undefined' ? participantEmail : '---') %></p>
          </div>
          
          <% if (participant && participant.phone) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Số điện thoại:</h3>
            <p class="text-gray-600"><%= participant.phone %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.workunit) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Đơn vị công tác:</h3>
            <p class="text-gray-600"><%= participant.workunit %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.address) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Địa chỉ:</h3>
            <p class="text-gray-600"><%= participant.address %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.age) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Tuổi:</h3>
            <p class="text-gray-600"><%= participant.age %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.business) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Lĩnh vực kinh doanh:</h3>
            <p class="text-gray-600"><%= participant.business %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.nationality) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Quốc tịch:</h3>
            <p class="text-gray-600"><%= participant.nationality %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.rank) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Cấp bậc:</h3>
            <p class="text-gray-600"><%= participant.rank %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.academic) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Học hàm học vị:</h3>
            <p class="text-gray-600"><%= participant.academic %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.position) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Chức vụ:</h3>
            <p class="text-gray-600"><%= participant.position %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.speciality) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Chuyên ngành:</h3>
            <p class="text-gray-600"><%= participant.speciality %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.role) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Vai trò:</h3>
            <p class="text-gray-600"><%= participant.role %></p>
          </div>
          <% } %>
          
          <% if (participant && typeof participant.speech !== 'undefined') { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Có phát biểu:</h3>
            <p class="text-gray-600"><%= participant.speech === true ? 'Có' : 'Không' %></p>
          </div>
          <% } %>
          
          <% if (participant && typeof participant.lunch !== 'undefined') { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Ăn trưa:</h3>
            <p class="text-gray-600"><%= participant.lunch === true ? 'Có' : 'Không' %></p>
          </div>
          <% } %>
          
          <% if (participant && typeof participant.dinner !== 'undefined') { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Ăn tối:</h3>
            <p class="text-gray-600"><%= participant.dinner === true ? 'Có' : 'Không' %></p>
          </div>
          <% } %>
          
          <% if (participant && typeof participant.transport !== 'undefined') { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Đăng ký theo xe về học viện:</h3>
            <p class="text-gray-600"><%= participant.transport === true ? 'Có' : 'Không' %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.source) { %>
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Bạn biết về hội nghị từ đâu:</h3>
            <p class="text-gray-600"><%= participant.source %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.feedback) { %>
          <div class="md:col-span-2">
            <h3 class="font-semibold text-gray-700 mb-1">Góp ý về công tác tổ chức:</h3>
            <p class="text-gray-600"><%- participant.feedback %></p>
          </div>
          <% } %>
          
          <% if (participant && participant.questions) { %>
          <div class="md:col-span-2">
            <h3 class="font-semibold text-gray-700 mb-1">Câu hỏi:</h3>
            <p class="text-gray-600"><%- participant.questions %></p>
          </div>
          <% } %>
          
          <div>
            <h3 class="font-semibold text-gray-700 mb-1">Ngày đăng ký:</h3>
            <p class="text-gray-600"><%= (participant && participant.registrationDate) ? new Date(participant.registrationDate).toLocaleDateString('vi-VN', {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'}) : new Date().toLocaleDateString('vi-VN', {year: 'numeric', month: 'long', day: 'numeric'}) %></p>
          </div>
        </div>
      </div>
      
      <div class="mb-6">
        <p class="text-gray-600 text-center italic">Vui lòng lưu lại trang này để tham khảo sau này.</p>
        <p class="text-gray-600 text-center mt-2">Chúng tôi đã gửi email xác nhận đến địa chỉ email của bạn.</p>
      </div>
     <!--  
      <div class="flex justify-between items-center">
        <a href="/register" class="btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium inline-flex items-center">
          Quay Lại
        </a>
        
        <button id="download-ticket" class="btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium inline-flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          In Xác Nhận
        </button>
      </div>
       -->
    </div>
  </div>
</section>

<!-- Footer with Logo -->
<section class="py-12 bg-white text-center">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-center mb-4">
      <svg class="h-8 w-8 text-blue-600 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
      </svg>
      <span class="text-2xl font-bold text-blue-600"><%= conference ? conference.name : "Hội Nghị" %></span>
    </div>
    
    <p class="text-gray-600"><%= formattedDates || '---' %></p>
    <p class="text-gray-600"><%= locationName || '---' %></p>
    
    <div class="flex justify-center mt-4 space-x-4">
      <a href="#" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z"/>
        </svg>
      </a>
      <a href="#" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm3 8h-1.35c-.538 0-.65.221-.65.778v1.222h2l-.209 2h-1.791v7h-3v-7h-2v-2h2v-2.308c0-1.769.931-2.692 3.029-2.692h1.971v3z"/>
        </svg>
      </a>
      <a href="#" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/>
        </svg>
      </a>
      <a href="#" class="text-gray-400 hover:text-gray-600">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
        </svg>
      </a>
    </div>
  </div>
</section>

<!-- Add JavaScript for PDF generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const downloadBtn = document.getElementById('download-ticket');
    
    // Ensure all EJS variables are defined and JS-escaped before being used in the script
    const pdfParticipantName = <%- JSON.stringify((participant && participant.name) ? participant.name : (typeof participantName !== 'undefined' ? participantName : "Quý vị")) %>;
    const pdfParticipantEmail = <%- JSON.stringify((participant && participant.email) ? participant.email : (typeof participantEmail !== 'undefined' ? participantEmail : "---")) %>;
    const pdfParticipantPhone = <%- JSON.stringify(participant && participant.phone ? participant.phone : "") %>;
    const pdfParticipantWorkunit = <%- JSON.stringify(participant && participant.workunit ? participant.workunit : "") %>;
    const pdfConferenceCode = <%- JSON.stringify(conference && conference.code ? conference.code : "N/A") %>;
    const pdfParticipantId = <%- JSON.stringify(typeof participantId !== 'undefined' ? participantId : "N/A") %>; // Using the new participantId
    const pdfConferenceName = <%- JSON.stringify(conference ? conference.name : "Hội Nghị") %>;
    const pdfConferenceStartDate = <%- JSON.stringify(conference && conference.startDate ? new Date(conference.startDate).toLocaleDateString("vi-VN", {year: "numeric", month: "long", day: "numeric"}) : "---") %>;
    const pdfConferenceTime = <%- JSON.stringify(conference && conference.time ? conference.time : "---") %>;
    const pdfLocationName = <%- JSON.stringify(typeof locationName !== 'undefined' ? locationName : "---") %>;
    const pdfMainSpeaker = <%- JSON.stringify(conference && conference.mainSpeaker ? conference.mainSpeaker : "") %>;


    if (downloadBtn) { // Check if the button exists before adding event listener
      downloadBtn.addEventListener('click', function() {
        try {
          const ticketContent = [
            {
              columns: [
                  { text: 'Họ tên:', style: 'fieldLabel', width: 'auto' },
                  { text: pdfParticipantName, style: 'fieldValue', width: '*' }
              ]
            },
            {
              columns: [
                  { text: 'Email:', style: 'fieldLabel', width: 'auto' },
                  { text: pdfParticipantEmail, style: 'fieldValue', width: '*' }
              ]
            },
          ];

          if (pdfParticipantPhone) {
            ticketContent.push({
              columns: [
                  { text: 'Điện thoại:', style: 'fieldLabel', width: 'auto' },
                  { text: pdfParticipantPhone, style: 'fieldValue', width: '*' }
              ]
            });
          }
          if (pdfParticipantWorkunit) {
            ticketContent.push({
              columns: [
                  { text: 'Đơn vị:', style: 'fieldLabel', width: 'auto' },
                  { text: pdfParticipantWorkunit, style: 'fieldValue', width: '*' }
              ]
            });
          }
          
          const eventDetailsContent = [
            { text: 'Tên hội nghị:', style: 'fieldLabel' },
            { text: pdfConferenceName, style: 'fieldValue' },
            { text: 'Ngày bắt đầu:', style: 'fieldLabel', margin: [0, 5, 0, 0] },
            { text: pdfConferenceStartDate, style: 'fieldValue' },
            { text: 'Thời gian:', style: 'fieldLabel', margin: [0, 5, 0, 0] },
            { text: pdfConferenceTime, style: 'fieldValue' },
            { text: 'Địa điểm:', style: 'fieldLabel', margin: [0, 5, 0, 0] },
            { text: pdfLocationName, style: 'fieldValue' },
          ];

          if (pdfMainSpeaker) {
            eventDetailsContent.push({ text: 'Diễn giả chính:', style: 'fieldLabel', margin: [0, 5, 0, 0] });
            eventDetailsContent.push({ text: pdfMainSpeaker, style: 'fieldValue' });
          }

          const docDefinition = {
            content: [
              {
                text: `PHIẾU THAM DỰ / INVITATION TICKET`,
                style: "header",
                alignment: "center",
                margin: [0, 0, 0, 20],
              },
              {
                canvas: [
                  {
                    type: "rect",
                    x: 0,
                    y: 0,
                    w: 515,
                    h: 130, 
                    r: 5,
                    lineColor: "#4A90E2",
                    lineWidth: 1,
                  },
                ],
                absolutePosition: { x: 40, y: 70 },
              },
              {
                columns: [
                  {
                    width: "*",
                    stack: [
                      { text: 'THÔNG TIN NGƯỜI THAM DỰ / ATTENDEE INFORMATION', style: 'subheader', margin: [ 0, 0, 0, 10] },
                      ...ticketContent
                    ],
                  },
                  {
                    width: 100,
                    qr: `CONF:${pdfConferenceCode};ID:${pdfParticipantId};NAME:${pdfParticipantName}`,
                    fit: "100",
                    alignment: "right",
                  },
                ],
                margin: [15, 15, 15, 15], 
                absolutePosition: { x: 50, y: 80 },
              },
              
              {
                text: "CHI TIẾT SỰ KIỆN / EVENT DETAILS",
                style: "subheader",
                alignment: "center",
                margin: [0, 15, 0, 10], 
                absolutePosition: { x: 40, y: 220 }
              },
              {
                style: 'eventDetails',
                table: {
                    widths: ['*'], 
                    body: [
                        [
                            {
                                stack: eventDetailsContent,
                                border: [false, false, false, false],
                                margin: [0,0,0,10]
                            }
                        ]
                    ]
                },
                layout: 'noBorders',
                absolutePosition: { x: 40, y: 250 }, 
            },
            
              {
                text: "Trân trọng cảm ơn sự tham gia của quý vị!",
                style: "thankYouNote",
                alignment: "center",
                margin: [0, 20, 0, 0],
                absolutePosition: { x: 40, y: 450 } // Adjusted Y position
              },
              {
                text: `Mã đăng ký: ${pdfParticipantId}`, // Use the new participantId
                style: 'registrationId', 
                alignment: 'center',
                absolutePosition: { x: 40, y: 480 } // Adjusted Y position
              }
            ],
            styles: {
              header: {
                fontSize: 24,
                bold: true,
                color: '#0056b3'
              },
              subheader: {
                fontSize: 16,
                bold: true
              },
              fieldLabel: {
                fontSize: 12,
                bold: true,
                margin: [0,0,5,0] // Add some right margin to label
              },
              fieldValue: {
                fontSize: 12
              },
              thankYouNote: {
                fontSize: 14,
                bold: true,
                color: '#0056b3'
              },
              registrationId: {
                fontSize: 12,
                bold: true
              }
            },
            defaultStyle: {
              font: 'Roboto'
            }
          };
          
          pdfMake.createPdf(docDefinition).download(`xac_nhan_dang_ky_${pdfParticipantName.replace(/\s+/g, '_')}.pdf`);
          
        } catch (error) {
          console.error('Lỗi khi tạo PDF:', error);
          alert('Lỗi khi tạo PDF. Vui lòng thử lại sau.');
        }
      });
    }
  });
</script> 